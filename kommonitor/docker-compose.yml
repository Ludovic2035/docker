version: '3.8'

networks:
  kommonitor:
    name: kommonitor
    driver: bridge

services:
  kommonitor-client:
    image: 'kommonitor/web-client:2.1.13'
    container_name: kommonitor-client
    restart: unless-stopped
    volumes:
      - ./client/base/config-storage-server.json.template:/usr/share/nginx/html/config/config-storage-server.json.template
      - ./client_config/base/webClientAppConfig.js.template:/usr/share/nginx/html/config/env_backup.js.template
      - ./client_config/base/webClientKeycloakConfig.json.template:/usr/share/nginx/html/config/keycloak_backup.json.template
      - ./client_config/base/webClientControlsConfig.json:/usr/share/nginx/html/config/controls-config_backup.json
    env_file:
      - ./config/base/client.env
    ports:
      - 8084:80
    networks:
      - kommonitor
    # Overwrite the default command so that config templates will be filled with env variables, first.
    # Subsequently, the actual command to start the nginx server will be called.
    command: 
      - /bin/sh
      - -c
      - |
        envsubst < /usr/share/nginx/html/config/config-storage-server.json.template > /usr/share/nginx/html/config/config-storage-server.json
        envsubst < /usr/share/nginx/html/config/env_backup.js.template > /usr/share/nginx/html/config/env_backup.js
        envsubst < /usr/share/nginx/html/config/keycloak_backup.json.template > /usr/share/nginx/html/config/keycloak_backup.json
        nginx -g 'daemon off;'

  kommonitor-client-config:
    image: 'kommonitor/client-config:2.0.4'
    container_name: kommonitor-client-config
    restart: unless-stopped
    ports:
      - 8088:8088
    networks:
      - kommonitor
    volumes:
      - ./client_config/base/webClientAppConfig.js.template:/code/configStorage/webClientAppConfig.js.template
      - ./client_config/base/webClientKeycloakConfig.json.template:/code/configStorage/webClientKeycloakConfig.json.template
      - ./client_config/base/webClientControlsConfig.json:/code/configStorage/webClientControlsConfig.json
    env_file:
      - ./config/base/client-config.env
    # Overwrite the default command so that config templates will be filled with env variables, first.
    # Subsequently, the actual command to start the Angular app will be called.
    command: 
      - /bin/sh
      - -c
      - |
        envsubst < /code/configStorage/webClientAppConfig.js.template > /code/configStorage/webClientAppConfig.js
        envsubst < /code/configStorage/webClientKeycloakConfig.json.template > /code/configStorage/webClientKeycloakConfig.json
        npm start

  redis:
    image: redis:alpine
    container_name: kommonitor-redis
    restart: unless-stopped
    networks:
      - kommonitor

  kommonitor-processing-engine:
    image: 'kommonitor/processing-engine:2.0.2'
    container_name: kommonitor-processing-engine
    restart: unless-stopped
    ports:
      - "8086:8086"
    networks:
      - kommonitor
    volumes:
      - ./processing_engine:/code/tmp
    depends_on:
      - redis
    env_file:
      - ./config/base/processing-engine.env

  kommonitor-processing-scheduler:
    image: 'kommonitor/processing-scheduler:2.0.2'
    container_name: kommonitor-processing-scheduler
    restart: unless-stopped
    networks:
      - kommonitor
    depends_on:
      - kommonitor-processing-engine
      - kommonitor-data-management
    env_file:
      - ./config/base/processing-scheduler.env

  kommonitor-importer:
    image: 'kommonitor/importer:2.0.5'
    container_name: kommonitor-importer
    restart: unless-stopped
    networks:
      - kommonitor
    ports:
      - 8087:8087
    volumes:
      - ./importer:/tmp/importer
    env_file:
      - ./config/base/importer.env
      - ./config/base/keycloak.env

  kommonitor-db:
    image: postgis/postgis:latest
    container_name: kommonitor-db
    restart: unless-stopped
    networks:
      - kommonitor
    ports:
      - 5432:5432
    volumes:
      - ./database/data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${DB_NAME} -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    env_file:
      - ./config/base/db.env

  kommonitor-data-management:
    image: kommonitor/data-management:2.1.8
    container_name: kommonitor-data-management
    restart: unless-stopped
    depends_on:
      kommonitor-db:
        condition: service_healthy
    ports:
      - "8085:8085"
    networks:
      - kommonitor
    links:
      - kommonitor-db
    env_file:
      - ./config/base/data-management.env
      - ./config/base/keycloak.env

  # optional pgadmin container to inspect the database
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    restart: unless-stopped
    ports:
      - 8083:80
    environment:
      - PGADMIN_DEFAULT_EMAIL=user@kommonitor.de
      - PGADMIN_DEFAULT_PASSWORD=kommonitor
    # volumes:
    #   - /var/kommonitor/pgadmin/servers.json:/pgadmin4/servers.json
    #   - /var/kommonitor/pgadmin/pgadmin:/var/lib/pgadmin
    networks:
      - kommonitor